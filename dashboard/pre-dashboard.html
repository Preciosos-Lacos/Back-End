<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard KPIs - Preciosos La√ßos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f2f2f2;
    }

    ul {
      padding-left: 1.2rem;
    }

    li {
      all: unset;
      display: list-item;
      list-style: none;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col">
  <header class="bg-purple-700 text-white p-4 text-center shadow-lg">
    <h1 class="text-3xl font-bold">Dashboard de Indicadores - Preciosos La√ßos</h1>
  </header>

  <main class="dashboard grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-6 flex-grow">
    <div class="card bg-white p-6 rounded-xl shadow-md flex flex-col">
      <h3 class="text-xl font-semibold mb-4 text-gray-800">Top 5 La√ßos Mais Vendidos</h3>
      <div class="flex-grow flex items-center justify-center">
        <canvas id="graficoTop5" class="w-full h-full"></canvas>
      </div>
    </div>

    <div class="card bg-white p-6 rounded-xl shadow-md flex flex-col">
      <h3 class="text-xl font-semibold mb-4 text-gray-800">Total em Vendas</h3>
      <div class="flex-grow flex items-center justify-center">
        <canvas id="graficoTotalVendas" class="w-full h-full"></canvas>
      </div>
      <p class="text-base font-semibold mt-2" id="totalVendasComp">--</p>
    </div>

    <div class="card bg-white p-6 rounded-xl shadow-md flex flex-col">
      <h3 class="text-xl font-semibold mb-4 text-gray-800">Clientes Novos</h3>
      <div class="flex-grow flex items-center justify-center">
        <canvas id="graficoClientesNovos" class="w-full h-full"></canvas>
      </div>
      <p class="text-base font-semibold mt-2" id="clientesNovosComp">--</p>
    </div>

    <div class="card bg-white p-6 rounded-xl shadow-md flex flex-col">
      <h3 class="text-xl font-semibold mb-4 text-gray-800">Clientes com Recompra</h3>
      <div class="flex-grow flex items-center justify-center">
        <canvas id="graficoClientesRecompra" class="w-full h-full"></canvas>
      </div>
      <p class="text-base font-semibold mt-2" id="clientesRecompraComp">--</p>
    </div>

    <div class="card bg-white p-6 rounded-xl shadow-md flex flex-col">
      <h3 class="text-xl font-semibold mb-4 text-gray-800">Formas de Pagamento</h3>
      <div class="flex-grow flex items-center justify-center">
        <canvas id="graficoFormasPagamento" class="w-full h-full"></canvas>
      </div>
      <p class="text-base font-semibold text-gray-700 mt-4">Mais Usada: <span id="pagamentoPopular">--</span></p>
      <p class="text-base font-semibold" id="pagamentoPopularComp">--</p>
    </div>

  </main>

  <script>
    const formatMoeda = valor => 'R$ ' + parseFloat(valor).toFixed(2).replace('.', ',');

    function mostrarComparacao(atual, anterior, idElemento) {
      const element = document.getElementById(idElemento);
      let texto = '';
      let textColorClass = 'text-gray-600'; 

      if (anterior === 0 && atual > 0) {
        texto = 'üìà Crescimento de 100%';
        textColorClass = 'text-green-600'; 
      } else if (anterior === 0 && atual === 0) {
        texto = 'üîÅ Sem movimenta√ß√£o';
        textColorClass = 'text-gray-600'; 
      } else {
        const variacao = ((atual - anterior) / anterior) * 100;
        const formattedVariacao = variacao.toFixed(1).replace('.', ',');

        if (variacao > 0) {
          texto = `üìà +${formattedVariacao}% em rela√ß√£o ao m√™s anterior`;
          textColorClass = 'text-green-600'; 
        } else if (variacao < 0) {
          texto = `üìâ ${formattedVariacao}% em rela√ß√£o ao m√™s anterior`;
          textColorClass = 'text-red-600';
        } else {
          texto = 'üîÅ Sem varia√ß√£o';
          textColorClass = 'text-gray-600'; // Gray for no change
        }
      }
      element.textContent = texto;
      // Remove previous color classes and add the new one
      element.classList.remove('text-green-600', 'text-red-600', 'text-gray-600');
      element.classList.add(textColorClass);
    }

    // Function to create a bar chart for current vs previous data
    function createComparisonBarChart(canvasId, title, currentData, previousData, comparisonElementId, isCurrency = false) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['M√™s Anterior', 'M√™s Atual'],
          datasets: [{
            label: title,
            data: [previousData, currentData],
            backgroundColor: ['#a78bfa', '#9900ff'], // Lighter purple for previous, main purple for current
            borderRadius: 8,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, // Allow charts to fill container
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function (context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += isCurrency ? formatMoeda(context.parsed.y) : context.parsed.y;
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: '#4b5563' }
            },
            y: {
              beginAtZero: true,
              grid: { color: '#e5e7eb' },
              ticks: {
                color: '#4b5563',
                callback: function (value) {
                  return isCurrency ? formatMoeda(value) : value;
                }
              }
            }
          }
        }
      });
      mostrarComparacao(currentData, previousData, comparisonElementId); // Call without isCurrency for styling
    }

    // Fetch KPI data
    fetch('http://localhost:3000/api/kpis')
      .then(res => {
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then(dados => {
        // --- Top 5 La√ßos Mais Vendidos Chart ---
        const top5Modelos = dados.top5.map(item => item.split(' (')[0]);
        const top5Quantidades = dados.top5.map(item => {
          const match = item.match(/\((\d+)/);
          return match ? parseInt(match[1]) : 0;
        });

        new Chart(document.getElementById('graficoTop5'), {
          type: 'bar',
          data: {
            labels: top5Modelos,
            datasets: [{
              label: 'Quantidade Vendida',
              data: top5Quantidades,
              backgroundColor: '#9900ff', // Main purple color
              borderRadius: 8
            }]
          },
          options: {
            indexAxis: 'y', // Horizontal bars
            responsive: true,
            maintainAspectRatio: false, // Allow charts to fill container
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: ctx => `${ctx.raw} vendidos`
                }
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: { precision: 0, color: '#4b5563' },
                grid: { color: '#e5e7eb' }
              },
              y: {
                grid: { display: false },
                ticks: { color: '#4b5563' }
              }
            }
          }
        });

        // --- Total em Vendas Chart ---
        createComparisonBarChart('graficoTotalVendas', 'Total em Vendas', dados.totalVendasAtual, dados.totalVendasAnterior, 'totalVendasComp', true);

        // --- Clientes Novos Chart ---
        createComparisonBarChart('graficoClientesNovos', 'Clientes Novos', dados.clientesNovosAtual, dados.clientesNovosAnterior, 'clientesNovosComp');

        // --- Clientes com Recompra Chart ---
        createComparisonBarChart('graficoClientesRecompra', 'Clientes com Recompra', dados.clientesRecompraAtual, dados.clientesRecompraAnterior, 'clientesRecompraComp');

        // --- Formas de Pagamento Chart (Top 3) ---
        const formasPagamentoLabels = dados.formasPagamentoTop3.map(fp => fp.nome);
        const formasPagamentoData = dados.formasPagamentoTop3.map(fp => fp.qtd_atual);

        new Chart(document.getElementById('graficoFormasPagamento'), {
          type: 'bar',
          data: {
            labels: formasPagamentoLabels,
            datasets: [{
              label: 'Quantidade de Transa√ß√µes',
              data: formasPagamentoData,
              backgroundColor: ['#9900ff', '#c084fc', '#e9d5ff'], // Shades of purple
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false, // Allow charts to fill container
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: ctx => `${ctx.raw} transa√ß√µes`
                }
              }
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: '#4b5563' }
              },
              y: {
                beginAtZero: true,
                ticks: { precision: 0, color: '#4b5563' },
                grid: { color: '#e5e7eb' }
              }
            }
          }
        });

        // Display text for most popular payment method with dynamic styling
        const pagamentoPopularElement = document.getElementById('pagamentoPopular');
        const pagamentoPopularCompElement = document.getElementById('pagamentoPopularComp');

        pagamentoPopularElement.textContent = dados.pagamentoPopularAtual;

        let pagamentoCompText = '';
        let pagamentoCompClass = 'text-gray-600'; // Default neutral color

        if (dados.pagamentoPopularAtual === dados.pagamentoPopularAnterior) {
          pagamentoCompText = 'üîÅ Igual ao m√™s anterior';
        } else {
          pagamentoCompText = `üîÑ Mudou (antes: ${dados.pagamentoPopularAnterior})`;
          // You might want to add more specific color logic here if a change is considered good/bad
          // For now, any change is neutral
        }
        pagamentoPopularCompElement.textContent = pagamentoCompText;
        pagamentoPopularCompElement.classList.remove('text-green-600', 'text-red-600', 'text-gray-600');
        pagamentoPopularCompElement.classList.add(pagamentoCompClass);

      })
      .catch(err => {
        console.error('Erro ao carregar KPIs:', err);
        // Display a user-friendly message in case of error
        document.querySelector('main.dashboard').innerHTML = `
          <div class="card bg-red-100 text-red-800 p-6 rounded-xl shadow-md col-span-full text-center">
            <h3 class="text-xl font-semibold mb-4">Erro ao Carregar Dados</h3>
            <p>N√£o foi poss√≠vel carregar os dados do dashboard. Por favor, verifique a conex√£o com a API.</p>
            <p class="text-sm mt-2">Detalhes do erro: ${err.message}</p>
          </div>
        `;
      });
  </script>
</body>

</html>